{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags seo_tags %}

{% block body_class %}article-page{% endblock %}

{% block content %}
<article class="article-detail">
    <!-- Hero Section -->
    <header class="article-hero">
        <div class="container">
            <!-- Breadcrumbs -->
            {% render_breadcrumbs self %}
            
            <!-- Article Header -->
            <div class="article-header" style="max-width: 800px; margin: 0 auto; text-align: center; padding: 2rem 0;">
                <!-- Meta Info -->
                <div class="article-meta" style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; font-size: var(--font-size-sm); color: var(--color-gray-500);">
                    {% if self.category %}
                    <a href="/blog/category/{{ self.category.slug }}/" 
                       class="category-badge"
                       style="background: {{ self.category.color|default:'var(--color-primary)' }}; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); text-decoration: none; font-weight: 500;">
                        {{ self.category.name }}
                    </a>
                    {% endif %}
                    
                    <time datetime="{{ self.first_published_at|date:'c' }}">
                        {{ self.first_published_at|date:"F d, Y" }}
                    </time>
                    
                    {% if self.reading_time_minutes %}
                    <span class="reading-time">
                        <svg style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ self.reading_time_minutes }} min read
                    </span>
                    {% endif %}
                    
                    <span class="view-count">
                        <svg style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        {{ self.view_count|default:0 }} views
                    </span>
                </div>
                
                <!-- Title -->
                <h1 class="article-title" style="font-family: var(--font-display); font-size: var(--font-size-4xl); font-weight: 700; line-height: var(--leading-tight); margin-bottom: 1rem; color: var(--color-gray-900);">
                    {{ self.title }}
                </h1>
                
                <!-- Intro/Summary -->
                {% if self.intro %}
                <p class="article-intro" style="font-size: var(--font-size-lg); color: var(--color-gray-600); line-height: var(--leading-relaxed); margin-bottom: 2rem;">
                    {{ self.intro }}
                </p>
                {% endif %}
                
                <!-- Social Share -->
                <div class="social-share" style="display: flex; justify-content: center; gap: 0.75rem; margin-bottom: 2rem;">
                    <button class="share-btn share-twitter" 
                            onclick="shareArticle('twitter')"
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #1DA1F2; color: white; border: none; border-radius: var(--radius-full); font-size: var(--font-size-sm); cursor: pointer; transition: all var(--transition-fast);">
                        <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Tweet
                    </button>
                    
                    <button class="share-btn share-linkedin" 
                            onclick="shareArticle('linkedin')"
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #0077b5; color: white; border: none; border-radius: var(--radius-full); font-size: var(--font-size-sm); cursor: pointer; transition: all var(--transition-fast);">
                        <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        Share
                    </button>
                    
                    <button class="share-btn share-copy" 
                            onclick="copyArticleUrl()"
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--color-gray-600); color: white; border: none; border-radius: var(--radius-full); font-size: var(--font-size-sm); cursor: pointer; transition: all var(--transition-fast);">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Copy
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Featured Image -->
        {% if self.featured_image %}
        <div class="article-featured-image" style="margin-bottom: 3rem;">
            <div class="container">
                <figure style="max-width: 800px; margin: 0 auto;">
                    <picture>
                        {% image self.featured_image width-1200 format-webp as img_webp %}
                        {% image self.featured_image width-1200 as img_fallback %}

                        <source srcset="{{ img_webp.url }}" type="image/webp">
                        <img src="{{ img_fallback.url }}" 
                             alt="{{ self.featured_image.title|default:self.title }}"
                             style="width: 100%; height: auto; border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);">
                    </picture>
                    {% if self.featured_image.title %}
                    <figcaption style="text-align: center; margin-top: 1rem; font-size: var(--font-size-sm); color: var(--color-gray-500);">
                        {{ self.featured_image.title }}
                    </figcaption>
                    {% endif %}
                </figure>
            </div>
        </div>
        {% endif %}
    </header>
    
    <!-- Article Content -->
    <div class="article-content">
        <div class="container">
            <div class="article-body" style="max-width: 800px; margin: 0 auto;">
                <div class="rich-text" style="font-family: var(--font-display); font-size: var(--font-size-lg); line-height: var(--leading-relaxed); color: var(--color-gray-800);">
                    {{ self.body|richtext }}
                </div>
                
                <!-- Tags -->
                {% if self.tags.all %}
                <div class="article-tags" style="margin: 3rem 0; padding: 2rem 0; border-top: 1px solid var(--color-gray-200); border-bottom: 1px solid var(--color-gray-200);">
                    <h3 style="font-size: var(--font-size-sm); font-weight: 600; color: var(--color-gray-700); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Tags</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% for tag in self.tags.all %}
                        <a href="/blog/tag/{{ tag.slug }}/" 
                           class="tag-link"
                           style="background: var(--color-gray-100); color: var(--color-gray-700); padding: 0.5rem 1rem; border-radius: var(--radius-full); text-decoration: none; font-size: var(--font-size-sm); font-weight: 500; transition: all var(--transition-fast);">
                            #{{ tag.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Related Articles -->
    <section class="related-articles" style="margin: 4rem 0; padding: 3rem 0; background: var(--color-gray-50);">
        <div class="container">
            <h2 style="font-family: var(--font-display); font-size: var(--font-size-3xl); font-weight: 600; text-align: center; margin-bottom: 3rem;">
                Related Articles
            </h2>
            
            <div id="related-articles-container" 
                 class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4"
                 hx-get="/blog/api/articles/{{ self.id }}/related/"
                 hx-target="this"
                 hx-trigger="load"
                 data-loading-class="loading">
                <!-- Related articles will be loaded here -->
                <div class="loading-placeholder" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 1rem; color: var(--color-gray-500);">Loading related articles...</p>
                </div>
            </div>
        </div>
    </section>
</article>

<script>
// Social sharing functions
function shareArticle(platform) {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    
    let shareUrl;
    switch(platform) {
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
            break;
        case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            break;
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            break;
    }
    
    if (shareUrl) {
        window.open(shareUrl, 'share', 'width=600,height=400,scrollbars=yes,resizable=yes');
        
        // Track share event
        fetch('/blog/api/share/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                article_id: {{ self.id }},
                platform: platform
            })
        });
    }
}

function copyArticleUrl() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        const btn = document.querySelector('.share-copy');
        const originalText = btn.innerHTML;
        btn.innerHTML = btn.innerHTML.replace('Copy', 'Copied!');
        btn.style.background = 'var(--color-accent)';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'var(--color-gray-600)';
        }, 2000);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Track page view
document.addEventListener('DOMContentLoaded', function() {
    // Set view count tracking data for middleware
    if (window.location.pathname.includes('/blog/')) {
        document.body.setAttribute('data-page-id', {{ self.id }});
    }
});
</script>

{% block extra_css %}
<style>
/* Article-specific styles */
.rich-text h2,
.rich-text h3,
.rich-text h4 {
    font-family: var(--font-display);
    font-weight: 600;
    color: var(--color-gray-900);
    margin: 2rem 0 1rem 0;
    line-height: var(--leading-tight);
}

.rich-text h2 {
    font-size: var(--font-size-2xl);
    border-bottom: 2px solid var(--color-gray-200);
    padding-bottom: 0.5rem;
}

.rich-text h3 {
    font-size: var(--font-size-xl);
}

.rich-text h4 {
    font-size: var(--font-size-lg);
}

.rich-text p {
    margin: 1.5rem 0;
    line-height: var(--leading-relaxed);
}

.rich-text ul,
.rich-text ol {
    margin: 1.5rem 0;
    padding-left: 2rem;
}

.rich-text li {
    margin: 0.5rem 0;
}

.rich-text blockquote {
    border-left: 4px solid var(--color-primary);
    margin: 2rem 0;
    padding: 1rem 2rem;
    background: var(--color-gray-50);
    border-radius: var(--radius);
    font-style: italic;
}

.rich-text code {
    background: var(--color-gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.9em;
    font-family: 'Courier New', monospace;
}

.rich-text pre {
    background: var(--color-gray-900);
    color: var(--color-gray-100);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    overflow-x: auto;
    margin: 2rem 0;
}

.rich-text pre code {
    background: none;
    padding: 0;
    color: inherit;
}

.rich-text a {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
}

.rich-text a:hover {
    color: var(--color-primary-dark);
}

.tag-link:hover {
    background: var(--color-primary) !important;
    color: white !important;
    transform: translateY(-1px);
}

.share-btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}
</style>
{% endblock %}
{% endblock %}